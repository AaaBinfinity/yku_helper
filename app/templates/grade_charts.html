<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æˆç»©å¯è§†åŒ–åˆ†æ - YKU å°åŠ©æ‰‹</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }
    h1 {
      margin-bottom: 2rem;
    }
    .chart-box {
      margin-bottom: 50px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .chart {
      width: 100%;
      height: 400px;
    }
    .back-btn {
      margin-bottom: 20px;
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <button onclick="history.back()" class="back-btn">â¬… è¿”å›ä¸Šä¸€çº§</button>
  <h1>ğŸ“Š æˆç»©å¯è§†åŒ–åˆ†æ</h1>

  <div class="chart-box">
    <h2>1ï¸âƒ£ å„å­¦æœŸå¹³å‡æˆç»©</h2>
    <div id="avg-grade-chart" class="chart"></div>
  </div>

  <div class="chart-box">
    <h2>2ï¸âƒ£ æˆç»©ç­‰çº§åˆ†å¸ƒ</h2>
    <div id="grade-pie-chart" class="chart"></div>
  </div>

  <div class="chart-box">
    <h2>3ï¸âƒ£ è¯¾ç¨‹æ€§è´¨çš„å¹³å‡æˆç»©</h2>
    <div id="kind-chart" class="chart"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script>
    function getAverage(nums) {
      const valid = nums.map(v => parseFloat(v)).filter(n => !isNaN(n));
      if (valid.length === 0) return 0;
      return (valid.reduce((a, b) => a + b, 0) / valid.length).toFixed(2);
    }

    function classify(score) {
      if (isNaN(score)) return "å…¶ä»–";
      if (score >= 90) return "ä¼˜ç§€";
      if (score >= 80) return "è‰¯å¥½";
      if (score >= 70) return "ä¸­ç­‰";
      if (score >= 60) return "åŠæ ¼";
      return "ä¸åŠæ ¼";
    }

    async function fetchGrades() {
      const params = new URLSearchParams(location.search);
      const res = await fetch("/api/grades?" + params.toString());
      const data = await res.json();
      if (!data.success) {
        alert("âŒ è·å–æˆç»©å¤±è´¥ï¼š" + (data.message || "æœªçŸ¥é”™è¯¯"));
        return [];
      }
      return data.data.grades || [];
    }

    async function renderCharts() {
      const grades = await fetchGrades();

      // 1. å„å­¦æœŸå¹³å‡æˆç»© - æ”¹ä¸ºæŠ˜çº¿å›¾
      const termMap = {};
      grades.forEach(row => {
        const term = row["å¼€è¯¾å­¦æœŸ"] || "æœªçŸ¥";
        const score = parseFloat(row["æˆç»©"]);
        if (!termMap[term]) termMap[term] = [];
        if (!isNaN(score)) termMap[term].push(score);
      });
      const terms = Object.keys(termMap).sort();
      const avgScores = terms.map(term => getAverage(termMap[term]));

      const avgChart = echarts.init(document.getElementById("avg-grade-chart"));
      avgChart.setOption({
        title: { text: "å„å­¦æœŸå¹³å‡æˆç»©", left: "center" },
        tooltip: {},
        xAxis: { type: 'category', data: terms },
        yAxis: { type: 'value' },
        series: [{
          name: "å¹³å‡æˆç»©",
          type: "line",
          data: avgScores,
          symbol: 'circle',
          symbolSize: 8,
          lineStyle: {
            width: 3
          },
          itemStyle: {
            borderWidth: 2
          }
        }]
      });

      // 2. æˆç»©ç­‰çº§åˆ†å¸ƒ
      const levelMap = {
        "ä¼˜ç§€": 0, "è‰¯å¥½": 0, "ä¸­ç­‰": 0, "åŠæ ¼": 0, "ä¸åŠæ ¼": 0, "å…¶ä»–": 0
      };
      grades.forEach(row => {
        const score = parseFloat(row["æˆç»©"]);
        const level = classify(score);
        levelMap[level]++;
      });
      const pieChart = echarts.init(document.getElementById("grade-pie-chart"));
      pieChart.setOption({
        title: { text: "æˆç»©ç­‰çº§åˆ†å¸ƒ", left: "center" },
        tooltip: { trigger: 'item' },
        legend: { bottom: 0 },
        series: [{
          name: "æˆç»©åˆ†å¸ƒ",
          type: "pie",
          radius: "50%",
          data: Object.entries(levelMap).map(([k, v]) => ({ name: k, value: v }))
        }]
      });

      // 3. è¯¾ç¨‹æ€§è´¨ â†’ å¹³å‡æˆç»©
      const kindMap = {};
      grades.forEach(row => {
        const kind = row["è¯¾ç¨‹æ€§è´¨"] || "æœªåˆ†ç±»";
        const score = parseFloat(row["æˆç»©"]);
        if (!kindMap[kind]) kindMap[kind] = [];
        if (!isNaN(score)) kindMap[kind].push(score);
      });
      const kindKeys = Object.keys(kindMap);
      const kindScores = kindKeys.map(k => getAverage(kindMap[k]));

      const kindChart = echarts.init(document.getElementById("kind-chart"));
      kindChart.setOption({
        title: { text: "è¯¾ç¨‹æ€§è´¨ vs å¹³å‡æˆç»©", left: "center" },
        tooltip: {},
        xAxis: { type: "category", data: kindKeys },
        yAxis: { type: "value" },
        series: [{ name: "å¹³å‡æˆç»©", type: "bar", data: kindScores }]
      });
    }

    renderCharts();
  </script>
</body>
</html>